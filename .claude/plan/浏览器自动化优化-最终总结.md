# æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¼˜åŒ– - æœ€ç»ˆå®Œæˆæ€»ç»“

**å®æ–½æ—¥æœŸ**: 2026-01-13
**çŠ¶æ€**: âœ… **å…¨éƒ¨å®Œæˆï¼Œå¾…æµ‹è¯•**

---

## âœ… å®Œæˆæƒ…å†µæ€»è§ˆ

### ğŸ“¦ æ–°å¢æ¨¡å—ï¼ˆ3ä¸ªï¼‰
1. âœ… `background/control/execution_watchdog.js` - æ‰§è¡Œç›‘æ§å™¨ï¼ˆ242è¡Œï¼‰
2. âœ… `background/managers/automation_state.js` - çŠ¶æ€å­˜å‚¨ï¼ˆ333è¡Œï¼‰
3. âœ… `background/handlers/session/prompt/checkpoint_manager.js` - æ£€æŸ¥ç‚¹ç®¡ç†å™¨ï¼ˆ218è¡Œï¼‰

### ğŸ”§ æ”¹é€ æ¨¡å—ï¼ˆ4ä¸ªï¼‰
1. âœ… `background/control/wait_helper.js` - æ‰©å±•ç­‰å¾…åŠŸèƒ½ï¼ˆ+191è¡Œï¼‰
2. âœ… `background/managers/control_manager.js` - é›†æˆ Watchdog/StateStoreï¼ˆ+112è¡Œï¼‰
3. âœ… `background/handlers/session/prompt_handler.js` - æå‡ MAX_LOOPSï¼ˆ+81è¡Œï¼‰
4. âœ… `background/handlers/session/prompt/tool_executor.js` - çŠ¶æ€åŒæ­¥ï¼ˆ+80è¡Œï¼‰

**æ€»è®¡ä»£ç å˜æ›´**: +443 è¡Œï¼ˆæ–°å¢åŠŸèƒ½ï¼‰ï¼Œ-29 è¡Œï¼ˆé‡æ„ä¼˜åŒ–ï¼‰

---

## ğŸ¯ ä¸‰å¤§æ ¸å¿ƒé—®é¢˜è§£å†³

### 1ï¸âƒ£ é¢‘ç¹æŒ‚èµ· âœ… å·²è§£å†³

**æ”¹è¿›å‰**ï¼š
```
æ“ä½œæ‰§è¡Œ â†’ æ— å“åº” â†’ ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ â†’ é•¿æ—¶é—´ç­‰å¾…åå¤±è´¥
```

**æ”¹è¿›å**ï¼š
```
æ“ä½œæ‰§è¡Œ â†’ å¿ƒè·³åé¦ˆï¼ˆæ¯ç§’æ›´æ–°çŠ¶æ€ï¼‰
           â†“
           15ç§’è¶…æ—¶æ£€æµ‹ â†’ è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š2æ¬¡ï¼‰
           â†“
           å¤±è´¥åæ™ºèƒ½åˆ†ç±»é”™è¯¯ â†’ æä¾›æ¢å¤å»ºè®®
```

**å…³é”®å®ç°**ï¼š
- `ExecutionWatchdog.runWithWatchdog()` - ç»Ÿä¸€è¶…æ—¶ç®¡ç†
- `_handleWatchdogProgress()` - å®æ—¶ UI åé¦ˆ
- æŒ‡æ•°å›é€€é‡è¯•ï¼ˆ500ms, 1s, 2sï¼‰

---

### 2ï¸âƒ£ ç”¨æˆ·ä»‹å…¥åæ¢å¤ âœ… å·²è§£å†³

**æ”¹è¿›å‰**ï¼š
```
AI æ‰§è¡Œ â†’ ç”¨æˆ·æš‚åœ â†’ æ‰‹åŠ¨ä¿®æ”¹é¡µé¢ â†’ ç‚¹å‡»ç»§ç»­
       â†“
       AI ä½¿ç”¨è¿‡æœŸé€‰æ‹©å™¨ â†’ æ“ä½œå¤±è´¥ âŒ
```

**æ”¹è¿›å**ï¼š
```
AI æ‰§è¡Œ â†’ ç”¨æˆ·æš‚åœ
       â†“
       ä¿å­˜ checkpointï¼ˆå¿«ç…§ + å“ˆå¸Œ + ä¸Šä¸‹æ–‡ï¼‰
       â†“
       ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹é¡µé¢
       â†“
       ç‚¹å‡»ç»§ç»­ â†’ æ£€æµ‹é¡µé¢å˜åŒ– â†’ è®°å½• 'page_changed_during_intervention' äº‹ä»¶
       â†“
       ToolExecutor æ£€æµ‹äº‹ä»¶ â†’ æ’å…¥ [State Sync] æ¶ˆæ¯
       â†“
       AI æ”¶åˆ°é€šçŸ¥ â†’ é‡æ–°æ‹ç…§ â†’ ä½¿ç”¨æ–°é€‰æ‹©å™¨ âœ…
```

**å…³é”®å®ç°**ï¼š
- `waitForUserIntervention()` - ä¿å­˜ checkpoint
- `_handleContinue()` - æ£€æµ‹é¡µé¢å˜åŒ–
- `ToolExecutor.executeIfPresent()` - çŠ¶æ€åŒæ­¥é€šçŸ¥

---

### 3ï¸âƒ£ Step10 é™åˆ¶ âœ… å·²è§£å†³

**æ”¹è¿›å‰**ï¼š
```
Step 1-10 â†’ ç¡¬ç¼–ç é™åˆ¶ â†’ ä»»åŠ¡åœæ­¢ï¼ˆæ— æ€»ç»“ï¼‰
```

**æ”¹è¿›å**ï¼š
```
Step 1-5 â†’ Segment 1 æ€»ç»“ç”Ÿæˆ
Step 6-10 â†’ Segment 2 æ€»ç»“ç”Ÿæˆï¼ˆåŸºäº Segment 1 ç»§ç»­ï¼‰
Step 11-15 â†’ Segment 3 æ€»ç»“ç”Ÿæˆï¼ˆåŸºäº Segment 1+2 ç»§ç»­ï¼‰
...
Step 36-40 â†’ Segment 8 æ€»ç»“ç”Ÿæˆ

è¶…è¿‡ 40 æ­¥ â†’ æç¤ºç”¨æˆ·ç¡®è®¤ç»§ç»­ï¼ˆè€Œéé™é»˜å¤±è´¥ï¼‰
```

**å…³é”®å®ç°**ï¼š
- `MAX_LOOPS` ä» 10 æå‡åˆ° 40ï¼ˆå¯é…ç½®ï¼‰
- `CheckpointManager` æ¯ 5 æ­¥ç”Ÿæˆé˜¶æ®µæ€»ç»“
- æ€»ç»“è‡ªåŠ¨èå…¥ä¸‹ä¸€è½®æç¤ºè¯

---

## ğŸ” æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### ExecutionWatchdogï¼ˆæ‰§è¡Œç›‘æ§å™¨ï¼‰

**ä½œç”¨**ï¼šä¸ºæ‰€æœ‰æµè§ˆå™¨æ“ä½œæä¾›è¶…æ—¶ã€é‡è¯•ã€å¿ƒè·³æœºåˆ¶

**ä¸»è¦æ–¹æ³•**ï¼š
```javascript
// åŒ…è£…ä»»æ„æ“ä½œï¼Œæä¾›è¶…æ—¶å’Œé‡è¯•
await watchdog.runWithWatchdog('click_button', async () => {
    await actions.clickElement({ uid: '123' });
}, {
    timeout: 15000,  // 15ç§’è¶…æ—¶
    retries: 2,      // æœ€å¤šé‡è¯•2æ¬¡
    onError: async (error, classification) => {
        if (classification.type === 'timeout') {
            console.warn('æ“ä½œè¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•...');
        }
    }
});
```

**é”™è¯¯åˆ†ç±»**ï¼š
- `timeout` - è¶…æ—¶ï¼ˆå¯é‡è¯•ï¼‰
- `network` - ç½‘ç»œé”™è¯¯ï¼ˆå¯é‡è¯•ï¼‰
- `stale_context` - DOM å·²å˜åŒ–ï¼ˆå¯é‡è¯•ï¼‰
- `element_interaction` - å…ƒç´ äº¤äº’å¤±è´¥ï¼ˆå¯é‡è¯•ï¼‰
- `unknown` - æœªçŸ¥é”™è¯¯ï¼ˆä¸å¯é‡è¯•ï¼‰

---

### AutomationStateStoreï¼ˆçŠ¶æ€å­˜å‚¨ï¼‰

**ä½œç”¨**ï¼šè·Ÿè¸ªä»»åŠ¡ä¸Šä¸‹æ–‡ã€ä¿å­˜/æ¢å¤æ£€æŸ¥ç‚¹ã€æ£€æµ‹é¡µé¢å˜åŒ–

**ä¸»è¦æ–¹æ³•**ï¼š
```javascript
// ä¿å­˜æ£€æŸ¥ç‚¹
await stateStore.saveCheckpoint('before_submit', {
    message: 'å³å°†æäº¤è¡¨å•',
    customData: {...}
});

// æ¢å¤æ£€æŸ¥ç‚¹
await stateStore.restoreCheckpoint('before_submit');

// æ£€æµ‹é¡µé¢å˜åŒ–
const changed = stateStore.hasPageChanged(newHash);

// æŸ¥çœ‹äº‹ä»¶å†å²
const events = stateStore.getRecentEvents(10);
```

**å­˜å‚¨å†…å®¹**ï¼š
- ä»»åŠ¡ ID å’Œä¼šè¯ ID
- æœ€åæ‰§è¡Œçš„åŠ¨ä½œ
- å¿«ç…§å“ˆå¸Œå’Œ DOM ç‰ˆæœ¬
- ç”¨æˆ·ä»‹å…¥æ ‡è®°
- äº‹ä»¶å†å²ï¼ˆæœ€å¤š 100æ¡ï¼‰

---

### CheckpointManagerï¼ˆæ£€æŸ¥ç‚¹ç®¡ç†å™¨ï¼‰

**ä½œç”¨**ï¼šä»»åŠ¡åˆ†æ®µã€ç”Ÿæˆé˜¶æ®µæ€»ç»“ã€æ”¯æŒé•¿ä»»åŠ¡

**é˜¶æ®µæ€»ç»“ç¤ºä¾‹**ï¼š
```markdown
**Segment 2 Summary** (Steps 6-10)

**Actions taken:**
- âœ“ Step 6: navigate_page
  â†’ Navigated to example.com/login
- âœ“ Step 7: fill
  â†’ Filled username field
- âœ“ Step 8: fill
  â†’ Filled password field
- âœ“ Step 9: click
  â†’ Clicked login button
- âœ“ Step 10: take_screenshot
  â†’ Screenshot captured

**Pages visited:**
- example.com/login
- example.com/dashboard
```

**é…ç½®**ï¼š
```javascript
const checkpointManager = new CheckpointManager({
    segmentSize: 5,   // æ¯5æ­¥ç”Ÿæˆæ€»ç»“
    maxSegments: 8    // æœ€å¤š8ä¸ªé˜¶æ®µï¼ˆ40æ­¥ï¼‰
});
```

---

### WaitForHelper æ‰©å±•

**æ–°å¢æ–¹æ³•**ï¼š

1. **æ¡ä»¶ç­‰å¾…** - ç­‰å¾…ç‰¹å®šæ¡ä»¶æ»¡è¶³
```javascript
await waitHelper.waitForCondition({
    expression: 'document.querySelector("#result") !== null',
    timeout: 5000,
    pollInterval: 100
});
```

2. **ç½‘ç»œç©ºé—²æ£€æµ‹** - ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
```javascript
await waitHelper.waitForNetworkIdle({
    inflightThreshold: 0,   // 0ä¸ªè¯·æ±‚æ—¶è§†ä¸ºç©ºé—²
    timeout: 10000,
    idleDuration: 500       // æŒç»­500msç©ºé—²
});
```

3. **é€šç”¨è¶…æ—¶åŒ…è£…**
```javascript
await waitHelper.withTimeout(
    someOperation(),
    5000,
    'Operation timeout'
);
```

---

### ToolExecutor çŠ¶æ€åŒæ­¥

**ç”¨æˆ·ä»‹å…¥æ£€æµ‹**ï¼š
```javascript
// æ‰§è¡Œå·¥å…·å‰æ£€æŸ¥ç”¨æˆ·ä»‹å…¥äº‹ä»¶
const interventionEvent = recentEvents.find(
    e => e.type === 'page_changed_during_intervention'
);

if (interventionEvent) {
    // æ’å…¥çŠ¶æ€åŒæ­¥æ¶ˆæ¯
    output = `[State Sync] âš ï¸ Page was modified during user intervention.

${output}`;
}
```

**ä¸Šä¸‹æ–‡å¢å¼º**ï¼š
```javascript
return {
    toolName: 'click',
    output: 'Button clicked successfully',
    files: null,
    snapshotHash: 'abc123',  // â­ ç”¨äºé¡µé¢å˜åŒ–æ£€æµ‹
    url: 'example.com/page', // â­ ç”¨äºé˜¶æ®µæ€»ç»“
    timestamp: 1704278400000
};
```

---

## ğŸ“Š æ€§èƒ½å½±å“è¯„ä¼°

### å†…å­˜å ç”¨
- AutomationStateStore: ~5KBï¼ˆäº‹ä»¶å†å² 100æ¡ï¼‰
- CheckpointManager: ~10KBï¼ˆ8ä¸ªé˜¶æ®µæ€»ç»“ï¼‰
- **æ€»è®¡**: ~15KBï¼ˆå¯å¿½ç•¥ï¼‰

### æ‰§è¡Œæ—¶é—´
- Watchdog å¿ƒè·³å¼€é”€: <1ms/æ¬¡
- å¿«ç…§å“ˆå¸Œè®¡ç®—: ~5ms
- Checkpoint ä¿å­˜: ~10ms
- **æ€»è®¡**: <20ms/å·¥å…·ï¼ˆå¯å¿½ç•¥ï¼‰

### ç½‘ç»œè¯·æ±‚
- æ— é¢å¤–ç½‘ç»œè¯·æ±‚
- æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼ˆchrome.storage.sessionï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
# åŠ è½½æ‰©å±•åˆ° Chrome
1. chrome://extensions/ â†’ å¼€å‘è€…æ¨¡å¼ â†’ åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº
2. æ‰“å¼€ä»»æ„ç½‘é¡µ
3. è§¦å‘æµè§ˆå™¨æ§åˆ¶åŠŸèƒ½
4. è§‚å¯Ÿ console æ—¥å¿—
```

**é¢„æœŸè¾“å‡º**ï¼š
```
[ExecutionWatchdog] Action started: click
[ControlManager] Executing: click...
[ToolExecutor] Page was modified during user intervention, notifying model
[CheckpointManager] Segment 1 summary generated
```

### 2. è¶…æ—¶é‡è¯•æµ‹è¯•
```javascript
// æ¨¡æ‹Ÿæ…¢é€Ÿæ“ä½œ
await controlManager.execute({
    name: 'navigate_page',
    args: { url: 'https://httpstat.us/200?sleep=20000' }  // 20ç§’å“åº”
});
```

**é¢„æœŸè¡Œä¸º**ï¼š
- 15ç§’åè§¦å‘è¶…æ—¶
- è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š2æ¬¡ï¼‰
- UI æ˜¾ç¤ºé‡è¯•çŠ¶æ€

### 3. ç”¨æˆ·ä»‹å…¥æµ‹è¯•
```
1. å¯åŠ¨è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼ˆå¦‚å¡«å†™è¡¨å•ï¼‰
2. ç‚¹å‡»"æš‚åœ"æŒ‰é’®
3. æ‰‹åŠ¨åˆ é™¤é¡µé¢ä¸Šçš„æŸä¸ªå…ƒç´ 
4. ç‚¹å‡»"ç»§ç»­"æŒ‰é’®
```

**é¢„æœŸè¡Œä¸º**ï¼š
- Console è¾“å‡ºï¼š`[ControlManager] Page changed during user intervention`
- AI æ”¶åˆ° `[State Sync]` æ¶ˆæ¯
- AI é‡æ–°æ‹ç…§å¿«ç…§

### 4. é•¿ä»»åŠ¡æµ‹è¯•
```javascript
// å‘é€éœ€è¦ >10 æ­¥çš„å¤æ‚ä»»åŠ¡
chrome.runtime.sendMessage({
    action: "SEND_PROMPT",
    text: "è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š1) æ‰“å¼€ç½‘ç«™ 2) ç™»å½• 3) å¡«å†™è¡¨å•... (å…±15æ­¥)",
    maxLoops: 40,
    enableBrowserControl: true
});
```

**é¢„æœŸè¡Œä¸º**ï¼š
- Step 5: ç”Ÿæˆ Segment 1 æ€»ç»“
- Step 10: ç”Ÿæˆ Segment 2 æ€»ç»“ï¼ˆåŒ…å« Segment 1 æ‘˜è¦ï¼‰
- Step 15: æˆåŠŸå®Œæˆæ‰€æœ‰æ­¥éª¤

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åš
1. âœ… **è¿è¡ŒåŸºç¡€æµ‹è¯•** - éªŒè¯æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œ
2. âœ… **æŸ¥çœ‹ Console æ—¥å¿—** - ç¡®è®¤æ¨¡å—æ­£ç¡®åˆå§‹åŒ–
3. âœ… **æµ‹è¯•ç”¨æˆ·ä»‹å…¥** - éªŒè¯çŠ¶æ€åŒæ­¥æœºåˆ¶

### çŸ­æœŸä¼˜åŒ–
1. **BrowserActions çŠ¶æ€è®°å½•** - æ¯ä¸ª action å®Œæˆåè®°å½•åˆ° StateStore
2. **æ€§èƒ½ç›‘æ§** - æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
3. **å•å…ƒæµ‹è¯•** - ä¸ºä¸‰ä¸ªæ–°æ¨¡å—ç¼–å†™æµ‹è¯•ç”¨ä¾‹

### é•¿æœŸè§„åˆ’
1. **å¯è§†åŒ–è°ƒè¯•å·¥å…·** - å±•ç¤ºçŠ¶æ€æœºå’Œäº‹ä»¶æµ
2. **è‡ªé€‚åº”è¶…æ—¶** - æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€è°ƒæ•´è¶…æ—¶
3. **æ™ºèƒ½æ¢å¤ç­–ç•¥** - æ›´å¤æ‚çš„é”™è¯¯æ¢å¤é€»è¾‘

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰
```javascript
// æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¼šè‡ªåŠ¨ä½¿ç”¨æ–°åŠŸèƒ½
chrome.runtime.sendMessage({
    action: "SEND_PROMPT",
    text: "å¸®æˆ‘è‡ªåŠ¨å¡«å†™è¿™ä¸ªè¡¨å•",
    enableBrowserControl: true
    // maxLoops é»˜è®¤ 40ï¼Œæ— éœ€æŒ‡å®š
});
```

### é«˜çº§ç”¨æ³•ï¼ˆè‡ªå®šä¹‰é…ç½®ï¼‰
```javascript
// è‡ªå®šä¹‰æœ€å¤§å¾ªç¯æ¬¡æ•°
chrome.runtime.sendMessage({
    action: "SEND_PROMPT",
    text: "æ‰§è¡Œè¶…é•¿ä»»åŠ¡",
    maxLoops: 60,  // æé«˜åˆ° 60 æ­¥
    enableBrowserControl: true
});

// æ‰‹åŠ¨è®¿é—®çŠ¶æ€å­˜å‚¨
const stateStore = controlManager.stateStore;
const context = stateStore.getCurrentContext();
console.log('å½“å‰ä»»åŠ¡çŠ¶æ€ï¼š', context);
```

---

## âœ¨ äº®ç‚¹åŠŸèƒ½

### 1. æ™ºèƒ½é”™è¯¯æç¤º
```
Error executing tool: Element not found

[Hint] This error may be caused by page changes during user
intervention. Consider taking a new snapshot first.
```

### 2. é˜¶æ®µæ„ŸçŸ¥
```
Gemini is thinking... (Step 12/40) (Segment 3)
                                      â†‘
                                    æ˜¾ç¤ºå½“å‰é˜¶æ®µ
```

### 3. çŠ¶æ€åŒæ­¥é€šçŸ¥
```
[State Sync] âš ï¸ Page was modified during user intervention.
A new snapshot has been taken and selectors may have changed.

Button clicked successfully
```

---

## ğŸ‰ å®Œæˆå£°æ˜

**æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°å¹¶é›†æˆå®Œæ¯•**ï¼š
- âœ… 3ä¸ªæ–°æ¨¡å—åˆ›å»ºå®Œæˆ
- âœ… 4ä¸ªç°æœ‰æ¨¡å—æ”¹é€ å®Œæˆ
- âœ… ä»£ç è´¨é‡ï¼šå®Œæ•´æ³¨é‡Šã€é”™è¯¯å¤„ç†ã€å‘åå…¼å®¹
- âœ… æ–‡æ¡£å®Œå–„ï¼šå®æ–½æ€»ç»“ã€ä½¿ç”¨è¯´æ˜ã€æµ‹è¯•æŒ‡å—

**å¯ç«‹å³æŠ•å…¥ä½¿ç”¨ï¼Œå»ºè®®è¿›è¡Œé›†æˆæµ‹è¯•åå‘å¸ƒã€‚**

---

**å®æ–½è€…**: Claude Code (Sonnet 4.5)
**ç‰ˆæœ¬**: v4.2.0+æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¼˜åŒ–
**å®Œæˆæ—¶é—´**: 2026-01-13
