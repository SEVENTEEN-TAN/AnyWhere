# å¤šæ ‡ç­¾é¡µé®æŒ¡å±‚åŠŸèƒ½ - æµ‹è¯•æŒ‡å—

**å®æ–½æ—¥æœŸ**: 2026-01-13
**çŠ¶æ€**: âœ… **å·²å®Œæˆ**

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

**é—®é¢˜**ï¼šAI åˆ›å»ºæ–°çª—å£/æ ‡ç­¾é¡µæ—¶ï¼Œæ–°æ ‡ç­¾é¡µæ²¡æœ‰æ˜¾ç¤ºé®æŒ¡å±‚ï¼Œç”¨æˆ·å¯èƒ½è¯¯æ“ä½œå¯¼è‡´å†²çªã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šè‡ªåŠ¨ç›‘å¬æ ‡ç­¾é¡µåˆ›å»ºäº‹ä»¶ï¼Œåœ¨æ§åˆ¶æ¨¡å¼ä¸‹ä¸ºæ‰€æœ‰æ–°æ ‡ç­¾é¡µè‡ªåŠ¨æ³¨å…¥é®æŒ¡å±‚ã€‚

---

## âœ¨ æ ¸å¿ƒæ”¹è¿›

### 1. æ ‡ç­¾é¡µç›‘å¬æœºåˆ¶

**æ–°å¢ç›‘å¬å™¨**ï¼š
- `chrome.tabs.onCreated` - ç›‘å¬æ–°æ ‡ç­¾é¡µåˆ›å»º
- `chrome.tabs.onUpdated` - ç›‘å¬æ ‡ç­¾é¡µåŠ è½½å®Œæˆ
- `chrome.tabs.onRemoved` - ç›‘å¬æ ‡ç­¾é¡µå…³é—­ï¼ˆæ¸…ç†ï¼‰

### 2. æ§åˆ¶æ ‡ç­¾é¡µç®¡ç†

**æ–°å¢å±æ€§**ï¼š
- `controlledTabs: Set` - è·Ÿè¸ªæ‰€æœ‰å—æ§æ ‡ç­¾é¡µ ID

**å·¥ä½œæµç¨‹**ï¼š
```
Control Mode å¯ç”¨
    â†“
å½“å‰æ ‡ç­¾é¡µåŠ å…¥ controlledTabs
    â†“
AI åˆ›å»ºæ–°æ ‡ç­¾é¡µ (chrome.tabs.create)
    â†“
onCreated ç›‘å¬å™¨è§¦å‘ â†’ æ ‡ç­¾é¡µåŠ å…¥ controlledTabs
    â†“
é¡µé¢åŠ è½½å®Œæˆ (status === 'complete')
    â†“
onUpdated ç›‘å¬å™¨è§¦å‘ â†’ è‡ªåŠ¨æ³¨å…¥é®æŒ¡å±‚
    â†“
æ–°æ ‡ç­¾é¡µä¹Ÿæœ‰é®æŒ¡å±‚æ˜¾ç¤º âœ…
```

### 3. é®æŒ¡å±‚æ³¨å…¥æ–¹å¼

**æ”¹è¿›**ï¼š
- ä½¿ç”¨ `chrome.scripting.executeScript` ä»£æ›¿ CDP
- ä¼˜ç‚¹ï¼šä¸éœ€è¦ attach debuggerï¼Œæ€§èƒ½æ›´å¥½
- æ³¨å…¥æ—¶æœºï¼šé¡µé¢ `status === 'complete'` æ—¶

### 4. æ¸…ç†æœºåˆ¶

**Control Mode ç¦ç”¨æ—¶**ï¼š
- éå†æ‰€æœ‰ `controlledTabs`
- åœ¨æ¯ä¸ªæ ‡ç­¾é¡µæ‰§è¡Œæ¸…ç†è„šæœ¬
- ç§»é™¤é®æŒ¡å±‚å’Œæ ·å¼
- æ¸…ç©º `controlledTabs` Set

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1ï¼šåŸºç¡€å¤šæ ‡ç­¾é¡µæµ‹è¯•

1. **å¯åŠ¨æ§åˆ¶æ¨¡å¼**
   ```
   æ‰“å¼€æ‰©å±• â†’ å‘é€å¸¦æµè§ˆå™¨æ§åˆ¶çš„æŒ‡ä»¤
   é¢„æœŸï¼šå½“å‰æ ‡ç­¾é¡µæ˜¾ç¤ºé®æŒ¡å±‚
   ```

2. **AI åˆ›å»ºæ–°æ ‡ç­¾é¡µ**
   ```
   è®© AI æ‰§è¡Œï¼š{"tool": "new_page", "args": {"url": "https://example.com"}}
   é¢„æœŸï¼šæ–°æ ‡ç­¾é¡µåŠ è½½å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºé®æŒ¡å±‚
   ```

3. **éªŒè¯**
   ```
   åˆ‡æ¢åˆ°æ–°æ ‡ç­¾é¡µ
   é¢„æœŸï¼šçœ‹åˆ°å‘¼å¸å…‰æ•ˆé®æŒ¡å±‚ï¼Œæ— æ³•ç‚¹å‡»é¡µé¢å…ƒç´ 
   ```

4. **ç¦ç”¨æ§åˆ¶æ¨¡å¼**
   ```
   ä»»åŠ¡å®Œæˆ â†’ Control Mode ç¦ç”¨
   é¢„æœŸï¼šæ‰€æœ‰æ ‡ç­¾é¡µçš„é®æŒ¡å±‚éƒ½æ¶ˆå¤±
   ```

### æµ‹è¯• 2ï¼šå¤šæ¬¡åˆ›å»ºæ ‡ç­¾é¡µ

1. **è®© AI è¿ç»­åˆ›å»º 3 ä¸ªæ ‡ç­¾é¡µ**
   ```javascript
   // è®© AI æ‰§è¡Œç±»ä¼¼ä»»åŠ¡
   "æ‰“å¼€ example.comã€google.com å’Œ github.com"
   ```

2. **éªŒè¯æ¯ä¸ªæ ‡ç­¾é¡µ**
   ```
   åˆ‡æ¢åˆ°æ¯ä¸ªæ–°æ ‡ç­¾é¡µ
   é¢„æœŸï¼šæ‰€æœ‰æ ‡ç­¾é¡µéƒ½æ˜¾ç¤ºé®æŒ¡å±‚
   ```

3. **æŸ¥çœ‹ Console æ—¥å¿—**
   ```
   F12 â†’ Console â†’ Service Worker
   é¢„æœŸï¼šçœ‹åˆ°ç±»ä¼¼æ—¥å¿—
   [ControlManager] New tab created, will inject overlay when loaded: 123
   [ControlManager] Injecting overlay into tab: 123 https://example.com
   [ControlManager] Overlay injected successfully into tab: 123
   ```

### æµ‹è¯• 3ï¼šé¡µé¢å¯¼èˆª

1. **åœ¨æ–°æ ‡ç­¾é¡µä¸­å¯¼èˆª**
   ```
   è®© AI åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰§è¡Œ navigate_page
   é¢„æœŸï¼šå¯¼èˆªå®Œæˆåé®æŒ¡å±‚ä¾ç„¶å­˜åœ¨
   ```

2. **éªŒè¯ controlledTabs**
   ```javascript
   // åœ¨ background service worker console ä¸­
   console.log(controlManager.controlledTabs)
   é¢„æœŸï¼šSet åŒ…å«æ‰€æœ‰æ ‡ç­¾é¡µ ID
   ```

### æµ‹è¯• 4ï¼šæ ‡ç­¾é¡µå…³é—­

1. **AI å…³é—­æŸä¸ªæ ‡ç­¾é¡µ**
   ```
   è®© AI æ‰§è¡Œï¼š{"tool": "close_page", "args": {"index": 1}}
   ```

2. **éªŒè¯æ¸…ç†**
   ```
   æŸ¥çœ‹ console
   é¢„æœŸï¼š[ControlManager] Controlled tab closed: 123
   ```

---

## ğŸ“‹ Console æ—¥å¿—è¯´æ˜

### æ­£å¸¸æµç¨‹æ—¥å¿—

```
[ControlManager] Control mode enabled - Page interaction blocked
[ControlManager] Controlled tabs: [123]
[ControlManager] New tab created, will inject overlay when loaded: 456
[ControlManager] Injecting overlay into tab: 456 https://example.com
[ControlManager] Overlay injected successfully into tab: 456
[ControlManager] Controlled tabs: [123, 456]
```

### æ¸…ç†æµç¨‹æ—¥å¿—

```
[ControlManager] Control mode disabled
[ControlManager] Cleaning up controlled tabs: [123, 456]
[ControlManager] Could not clean up tab: 456  // æ ‡ç­¾é¡µå·²å…³é—­ï¼ˆæ­£å¸¸ï¼‰
```

### é”™è¯¯æ—¥å¿—ï¼ˆæ­£å¸¸æƒ…å†µï¼‰

```
[ControlManager] Skipping restricted URL: chrome://extensions/
[ControlManager] Failed to inject overlay into tab: 789 Cannot access chrome:// URL
```

---

## ğŸ” ä»£ç å˜æ›´è¯¦æƒ…

### æ–°å¢æ–¹æ³•

1. **`_setupTabListeners()`**
   - è®¾ç½® 3 ä¸ªæ ‡ç­¾é¡µäº‹ä»¶ç›‘å¬å™¨
   - åœ¨æ„é€ å‡½æ•°ä¸­è‡ªåŠ¨è°ƒç”¨

2. **`_injectOverlayToTab(tabId)`**
   - ä½¿ç”¨ `chrome.scripting.executeScript` æ³¨å…¥é®æŒ¡å±‚
   - æ£€æŸ¥å—é™ URLï¼ˆchrome://, edge://, about:ï¼‰
   - é¿å…é‡å¤æ³¨å…¥ï¼ˆæ£€æŸ¥ `#gemini-control-overlay`ï¼‰

### ä¿®æ”¹æ–¹æ³•

1. **`enableControlMode()`**
   - æ·»åŠ å½“å‰æ ‡ç­¾é¡µåˆ° `controlledTabs`
   - æ‰“å°å—æ§æ ‡ç­¾é¡µåˆ—è¡¨

2. **`disableControlMode()`**
   - æ¸…ç†æ‰€æœ‰å—æ§æ ‡ç­¾é¡µçš„é®æŒ¡å±‚
   - æ¸…ç©º `controlledTabs` Set

### æ–°å¢å±æ€§

```javascript
this.controlledTabs = new Set();  // è·Ÿè¸ªæ‰€æœ‰å—æ§æ ‡ç­¾é¡µ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å—é™ URL
**æ— æ³•æ³¨å…¥çš„é¡µé¢**ï¼š
- `chrome://` é¡µé¢ï¼ˆå¦‚ chrome://extensionsï¼‰
- `edge://` é¡µé¢
- `about:` é¡µé¢
- Chrome Web Store

**è¡Œä¸º**ï¼šè‡ªåŠ¨è·³è¿‡ï¼Œä¸æŠ¥é”™

### 2. æƒé™è¦æ±‚
**éœ€è¦çš„æƒé™**ï¼ˆmanifest.json å·²åŒ…å«ï¼‰ï¼š
- `scripting` - ç”¨äºæ³¨å…¥é®æŒ¡å±‚è„šæœ¬
- `tabs` - ç”¨äºç›‘å¬æ ‡ç­¾é¡µäº‹ä»¶

### 3. æ—¶åºé—®é¢˜
**é¡µé¢åŠ è½½å®Œæˆå‰**ï¼š
- é®æŒ¡å±‚ä¼šåœ¨ `status === 'complete'` æ—¶æ³¨å…¥
- å¿«é€Ÿå¯¼èˆªå¯èƒ½æœ‰çŸ­æš‚å»¶è¿Ÿ

### 4. æ€§èƒ½å½±å“
**æœ€å°åŒ–**ï¼š
- ä»…åœ¨æ§åˆ¶æ¨¡å¼å¯ç”¨æ—¶ç›‘å¬äº‹ä»¶
- ä½¿ç”¨ `chrome.scripting` æ¯” CDP æ€§èƒ½æ›´å¥½
- æ³¨å…¥çš„ä»£ç éå¸¸è½»é‡ï¼ˆ<5KBï¼‰

---

## ğŸš€ æœªæ¥ä¼˜åŒ–å»ºè®®

### 1. Content Script æ–¹æ¡ˆï¼ˆé•¿æœŸï¼‰
```json
// manifest.json
"content_scripts": [{
  "matches": ["<all_urls>"],
  "js": ["content/control_overlay.js"],
  "run_at": "document_start"
}]
```

**ä¼˜ç‚¹**ï¼š
- æ‰€æœ‰é¡µé¢è‡ªåŠ¨åŠ è½½
- æ— éœ€åŠ¨æ€æ³¨å…¥
- æ›´å¿«çš„å“åº”æ—¶é—´

**ç¼ºç‚¹**ï¼š
- æ‰€æœ‰é¡µé¢éƒ½ä¼šåŠ è½½è„šæœ¬ï¼ˆå³ä½¿ä¸ä½¿ç”¨ï¼‰
- éœ€è¦é‡æ„ç°æœ‰ä»£ç 

### 2. è·¨çª—å£æ”¯æŒ
**å½“å‰**ï¼šä»…æ”¯æŒå½“å‰çª—å£çš„æ ‡ç­¾é¡µ

**æœªæ¥**ï¼šç›‘å¬ `chrome.windows.onCreated`ï¼Œæ”¯æŒå¤šçª—å£

### 3. æŒä¹…åŒ–å—æ§æ ‡ç­¾é¡µåˆ—è¡¨
**å½“å‰**ï¼šä»…å­˜åœ¨å†…å­˜ä¸­

**æœªæ¥**ï¼šä¿å­˜åˆ° `chrome.storage.session`ï¼Œæ‰©å±•é‡å¯åæ¢å¤

---

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
- `background/managers/control_manager.js` (+197 è¡Œ)

### æ–°å¢ä»£ç è¡Œæ•°
- 197 è¡Œï¼ˆåŒ…å«æ³¨é‡Šï¼‰

### å½±å“çš„åŠŸèƒ½
- âœ… `new_page` - æ–°æ ‡ç­¾é¡µè‡ªåŠ¨æ˜¾ç¤ºé®æŒ¡å±‚
- âœ… `navigate_page` - å¯¼èˆªæ—¶ä¿æŒé®æŒ¡å±‚
- âœ… `close_page` - å…³é—­æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨æ¸…ç†
- âœ… å¤šæ ‡ç­¾é¡µæ“ä½œ - æ‰€æœ‰æ ‡ç­¾é¡µç»Ÿä¸€ç®¡ç†

---

**æµ‹è¯•è´Ÿè´£äºº**: å¾…æŒ‡å®š
**é¢„æœŸæµ‹è¯•æ—¶é—´**: 15-30 åˆ†é’Ÿ
**çŠ¶æ€**: å¾…æµ‹è¯•éªŒè¯
